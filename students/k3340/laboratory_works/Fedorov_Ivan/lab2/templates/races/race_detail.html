{% extends 'base.html' %}

{% block title %}{{ race.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'race_list' %}">–ì–æ–Ω–∫–∏</a></li>
                <li class="breadcrumb-item active">{{ race.name }}</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>{{ race.name }}</h1>
            {% if user.is_staff %}
                <a href="{% url 'admin:races_race_change' race.id %}" class="btn btn-outline-secondary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            {% endif %}
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <p class="lead">{{ race.description }}</p>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>üìÖ –î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:</strong> {{ race.date|date:"d.m.Y H:i" }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>üë• –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ:</strong> {{ race.get_registered_users_count }} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-4">
            {% if user.is_authenticated %}
                {% if user_registration %}
                    <div class="alert alert-success">
                        <strong>‚úÖ –í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —ç—Ç—É –≥–æ–Ω–∫—É!</strong>
                        <form method="post" action="{% url 'unregister_from_race' race.id %}" class="d-inline ms-2">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-warning btn-sm">–û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</button>
                        </form>
                    </div>
                {% else %}
                    <form method="post" action="{% url 'register_for_race' race.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success">üèÅ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –≥–æ–Ω–∫—É</button>
                        <small class="text-muted ms-2">–°—Ç–∞–Ω—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —ç—Ç–æ–π –≥–æ–Ω–∫–∏!</small>
                    </form>
                {% endif %}
            {% else %}
                <div class="alert alert-info">
                    <a href="{% url 'login' %}" class="btn btn-primary">–í–æ–π–¥–∏—Ç–µ</a> –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –≥–æ–Ω–∫—É
                </div>
            {% endif %}
        </div>

        <h3>üèÜ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–Ω–∫–∏</h3>
        {% if results %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>–ú–µ—Å—Ç–æ</th>
                            <th>–ì–æ–Ω—â–∏–∫</th>
                            <th>–ö–æ–º–∞–Ω–¥–∞</th>
                            <th>–û–ø—ã—Ç</th>
                            <th>–í—Ä–µ–º—è –∫—Ä—É–≥–∞</th>
                            <th>–ö—Ä—É–≥–∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in results %}
                            <tr {% if result.user == user %}class="table-info"{% endif %}>
                                <td>
                                    {% if result.position == 1 %}
                                        <span class="badge bg-warning text-dark">ü•á {{ result.position }}</span>
                                    {% elif result.position == 2 %}
                                        <span class="badge bg-secondary">ü•à {{ result.position }}</span>
                                    {% elif result.position == 3 %}
                                        <span class="badge bg-danger">ü•â {{ result.position }}</span>
                                    {% else %}
                                        {{ result.position }}
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ result.user.get_full_name|default:result.user.username }}</strong>
                                    {% if result.user == user %}
                                        <span class="badge bg-primary">–í—ã</span>
                                    {% endif %}
                                </td>
                                <td>{{ result.user.team_name|default:"-" }}</td>
                                <td>
                                    <span class="badge bg-light text-dark">{{ result.user.get_experience_display }}</span>
                                </td>
                                <td>{{ result.get_lap_time_display }}</td>
                                <td>{{ result.completed_laps }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">
                <h5>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</h5>
                <p class="mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–æ–Ω–∫–∏.</p>
            </div>
        {% endif %}

        <h3 class="mt-5 mb-4" id="comments">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ race.comment_set.count }})</h3>

        {% if user.is_authenticated %}
            <div class="mb-4">
                <a href="{% url 'add_comment' race.id %}" class="btn btn-primary">
                    ‚úèÔ∏è –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                </a>
            </div>
        {% else %}
            <div class="alert alert-warning mb-4">
                <a href="{% url 'login' %}" class="btn btn-sm btn-primary">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            </div>
        {% endif %}

        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π -->
        {% if page_obj.object_list %}
            {% for comment in page_obj %}
                <div class="card mb-3 {% if comment.author == user %}border-primary{% endif %}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="card-title mb-1">
                                <strong>{{ comment.author.get_full_name|default:comment.author.username }}</strong>
                                <small class="text-muted">- {{ comment.created_at|date:"d.m.Y H:i" }}</small>
                            </h6>
                            <span class="badge bg-secondary">{{ comment.get_comment_type_display }}</span>
                        </div>
                        <p class="card-text mt-2">{{ comment.text|linebreaks }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-warning text-dark">‚≠ê –†–µ–π—Ç–∏–Ω–≥: {{ comment.rating }}/10</span>
                                <small class="text-muted ms-2">üìÖ –ó–∞–µ–∑–¥: {{ comment.race_date|date:"d.m.Y" }}</small>
                            </div>
                            {% if comment.author == user %}
                                <form method="post" action="{% url 'delete_comment' comment.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}

            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
            {% if page_obj.paginator.num_pages > 1 %}
                <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1#comments" aria-label="–ü–µ—Ä–≤–∞—è">
                                    <span aria-hidden="true">&laquo;&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}#comments" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}#comments">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}#comments" aria-label="–°–ª–µ–¥—É—é—â–∞—è">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}#comments" aria-label="–ü–æ—Å–ª–µ–¥–Ω—è—è">
                                    <span aria-hidden="true">&raquo;&raquo;</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>

                    <div class="text-center mt-2">
                        <small class="text-muted">
                            –ü–æ–∫–∞–∑–∞–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ {{ page_obj.start_index }}-{{ page_obj.end_index }} –∏–∑ {{ page_obj.paginator.count }}
                        </small>
                    </div>
                </nav>
            {% endif %}
        {% else %}
            <div class="alert alert-info text-center">
                <h5>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</h5>
                <p class="mb-0">–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –æ—Å—Ç–∞–≤–∏—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —ç—Ç–æ–π –≥–æ–Ω–∫–µ!</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}